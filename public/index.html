<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>A-Team Console v5.6</title>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;700&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      min-height: 100vh;
      background: linear-gradient(145deg, #0C0C1D 0%, #1A1A2E 40%, #16213E 100%);
      color: #E2E8F0;
      font-family: 'JetBrains Mono', 'Fira Code', monospace;
    }

    .header {
      padding: 20px 24px;
      border-bottom: 1px solid rgba(255,255,255,0.06);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .header-left { display: flex; align-items: center; gap: 16px; }

    .logo {
      width: 40px; height: 40px; border-radius: 10px;
      background: linear-gradient(135deg, #F59E0B, #EF4444);
      display: flex; align-items: center; justify-content: center;
      font-size: 20px; font-weight: 700; color: #fff;
    }

    .header-title {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 28px; font-weight: 700;
      background: linear-gradient(135deg, #F59E0B, #EF4444, #3B82F6, #10B981);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
      background-clip: text; letter-spacing: -0.5px;
    }

    .header-sub {
      font-size: 11px; color: #64748B; letter-spacing: 1px; margin-top: 2px;
    }

    .status-badge {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 4px 12px; border-radius: 20px; font-size: 11px;
      font-weight: 500; letter-spacing: 0.5px;
      background: rgba(16,185,129,0.15); color: #10B981;
      border: 1px solid rgba(16,185,129,0.3);
    }

    .status-dot {
      width: 6px; height: 6px; border-radius: 50%; background: #10B981;
    }

    .container { max-width: 1200px; margin: 0 auto; padding: 24px; }

    .roster {
      display: grid; grid-template-columns: repeat(4, 1fr);
      gap: 12px; margin-bottom: 24px;
    }

    .roster-card {
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: 10px; padding: 12px 14px;
      display: flex; align-items: center; gap: 10px;
      transition: all 0.3s;
    }

    .roster-card.active { border-color: var(--agent-color); }
    .roster-card.active .agent-avatar { opacity: 1; }

    .agent-avatar {
      width: 32px; height: 32px; border-radius: 8px;
      display: flex; align-items: center; justify-content: center;
      font-size: 14px; font-weight: 700; color: #fff; flex-shrink: 0;
    }

    .agent-name {
      font-size: 13px; font-weight: 600; color: #E2E8F0;
      font-family: 'Space Grotesk', sans-serif;
    }

    .agent-role {
      font-size: 10px; color: #64748B; white-space: nowrap;
      overflow: hidden; text-overflow: ellipsis;
    }

    .thinking-label {
      margin-left: auto; font-size: 10px; font-weight: 600;
      flex-shrink: 0; animation: pulse 1.5s ease-in-out infinite;
    }

    .done-dot {
      margin-left: auto; width: 8px; height: 8px;
      border-radius: 50%; background: #10B981; flex-shrink: 0;
    }

    @keyframes pulse { 0%,100% { opacity: 0.4; } 50% { opacity: 1; } }
    @keyframes slideIn { from { opacity:0; transform:translateY(12px); } to { opacity:1; transform:translateY(0); } }

    .query-area { margin-bottom: 24px; }

    .query-input {
      width: 100%; background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.12); border-radius: 12px;
      padding: 16px 20px; color: #E2E8F0;
      font-family: 'JetBrains Mono', monospace; font-size: 14px;
      outline: none; resize: none; transition: border-color 0.2s;
    }

    .query-input:focus {
      border-color: rgba(245,158,11,0.5);
      box-shadow: 0 0 0 3px rgba(245,158,11,0.1);
    }

    .query-input::placeholder { color: rgba(255,255,255,0.3); }

    .query-footer {
      display: flex; justify-content: space-between;
      align-items: center; margin-top: 10px; gap: 12px;
    }

    .query-hint { font-size: 11px; color: #475569; }

    .query-controls {
      display: flex; align-items: center; gap: 12px; flex-shrink: 0;
    }

    .run-btn {
      background: linear-gradient(135deg, #F59E0B, #D97706);
      color: #000; border: none; border-radius: 12px;
      padding: 16px 32px; font-family: 'Space Grotesk', sans-serif;
      font-weight: 600; font-size: 15px; cursor: pointer;
      transition: all 0.2s; letter-spacing: 0.5px;
    }

    .run-btn:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 4px 20px rgba(245,158,11,0.3);
    }

    .run-btn:disabled { opacity: 0.5; cursor: not-allowed; }

    .error-box {
      background: rgba(220,38,38,0.1);
      border: 1px solid rgba(220,38,38,0.3);
      border-radius: 10px; padding: 16px; margin-bottom: 20px;
      font-size: 13px; color: #FCA5A5;
    }

    .responses { display: flex; flex-direction: column; gap: 16px; }

    .response-card {
      border-radius: 12px; padding: 16px; position: relative;
      overflow: hidden; animation: slideIn 0.4s ease-out forwards;
    }

    .response-card .top-bar {
      position: absolute; top: 0; left: 0; right: 0; height: 3px;
      border-radius: 12px 12px 0 0;
    }

    .response-header {
      display: flex; align-items: center; gap: 10px; margin-bottom: 12px;
    }

    .response-avatar {
      width: 28px; height: 28px; border-radius: 7px;
      display: flex; align-items: center; justify-content: center;
      font-size: 12px; font-weight: 700; color: #fff;
    }

    .response-name {
      font-family: 'Space Grotesk', sans-serif;
      font-weight: 600; font-size: 14px; color: #F1F5F9;
    }

    .response-role { color: #64748B; font-size: 12px; margin-left: 8px; }

    .provider-tag {
      margin-left: auto; font-size: 9px; color: #475569;
      letter-spacing: 1px; text-transform: uppercase;
      padding: 2px 8px; border-radius: 4px;
      background: rgba(255,255,255,0.05);
    }

    .response-text {
      font-size: 13px; line-height: 1.7; color: #CBD5E1;
      white-space: pre-wrap; word-wrap: break-word; overflow-wrap: break-word;
    }

    .synthesis-card {
      background: linear-gradient(135deg, rgba(245,158,11,0.08), rgba(239,68,68,0.05));
      border: 1px solid rgba(245,158,11,0.25);
      border-radius: 12px; padding: 20px; position: relative;
      animation: slideIn 0.4s ease-out forwards;
    }

    .synthesis-card .top-bar {
      position: absolute; top: 0; left: 0; right: 0; height: 3px;
      background: linear-gradient(90deg, #F59E0B, #EF4444, #3B82F6, #10B981);
      border-radius: 12px 12px 0 0;
    }

    .empty-state {
      text-align: center; padding: 60px 20px; color: #475569;
    }

    .empty-star { font-size: 40px; margin-bottom: 16px; }

    .empty-title {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 18px; font-weight: 600; color: #64748B; margin-bottom: 8px;
    }

    .empty-text {
      font-size: 13px; max-width: 400px; margin: 0 auto; line-height: 1.6;
    }

    .suggestions {
      margin-top: 24px; display: flex; gap: 8px;
      justify-content: center; flex-wrap: wrap;
    }

    .suggestion-btn {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 8px; padding: 8px 14px; color: #94A3B8;
      font-size: 12px; cursor: pointer;
      font-family: 'JetBrains Mono', monospace;
      transition: all 0.2s;
    }

    .suggestion-btn:hover {
      background: rgba(255,255,255,0.1); color: #E2E8F0;
    }

    .history-btn {
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 8px; padding: 8px 16px; color: #94A3B8;
      font-family: 'JetBrains Mono', monospace; font-size: 12px;
      cursor: pointer; transition: all 0.2s;
    }

    .history-btn:hover { background: rgba(255,255,255,0.1); color: #E2E8F0; }

    .history-panel {
      margin-top: 24px; background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 12px; padding: 20px;
    }

    .history-title {
      font-family: 'Space Grotesk', sans-serif;
      font-weight: 600; font-size: 16px; margin-bottom: 16px; color: #E2E8F0;
    }

    .history-item {
      padding: 12px 0; cursor: pointer;
      border-bottom: 1px solid rgba(255,255,255,0.06);
    }

    .history-item:last-child { border-bottom: none; }
    .history-query { font-size: 13px; color: #E2E8F0; margin-bottom: 4px; }
    .history-meta { font-size: 11px; color: #64748B; }

    /* Mode toggle */
    .mode-toggle {
      display: inline-flex; align-items: center; position: relative;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 24px; padding: 3px;
      cursor: pointer; user-select: none; transition: all 0.3s;
    }
    .mode-toggle.deep {
      border-color: rgba(217,119,6,0.5);
      box-shadow: 0 0 15px rgba(217,119,6,0.15), 0 0 4px rgba(217,119,6,0.1);
    }
    .mode-slider {
      position: absolute; top: 3px; left: 3px;
      height: calc(100% - 6px); border-radius: 20px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      background: rgba(255,255,255,0.1);
    }
    .mode-toggle.deep .mode-slider {
      background: linear-gradient(135deg, #D97706, #F59E0B);
    }
    .mode-opt {
      padding: 6px 14px; font-size: 11px; font-weight: 600;
      letter-spacing: 0.5px; font-family: 'Space Grotesk', sans-serif;
      z-index: 1; position: relative; transition: color 0.3s;
      color: #64748B; white-space: nowrap;
    }
    .mode-opt.active { color: #E2E8F0; }
    .mode-toggle.deep .mode-opt.active { color: #000; }

    /* Confirmation dialog */
    .confirm-overlay {
      position: fixed; inset: 0; z-index: 9998;
      background: rgba(0,0,0,0.7);
      display: flex; align-items: center; justify-content: center;
      backdrop-filter: blur(4px);
    }
    .confirm-box {
      background: linear-gradient(145deg, #1A1A2E, #16213E);
      border: 1px solid rgba(217,119,6,0.3);
      border-radius: 16px; padding: 32px; max-width: 420px; width: calc(100% - 32px);
      text-align: center; box-shadow: 0 0 40px rgba(217,119,6,0.1);
    }
    .confirm-icon { font-size: 40px; margin-bottom: 12px; }
    .confirm-title {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 20px; font-weight: 700; color: #F59E0B; margin-bottom: 8px;
    }
    .confirm-text {
      font-size: 13px; color: #94A3B8; line-height: 1.6; margin-bottom: 24px;
    }
    .confirm-btns { display: flex; gap: 12px; justify-content: center; }
    .confirm-no {
      padding: 10px 24px; border-radius: 10px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.12);
      color: #94A3B8; font-family: 'Space Grotesk', sans-serif;
      font-weight: 600; font-size: 13px; cursor: pointer; transition: all 0.2s;
    }
    .confirm-no:hover { background: rgba(255,255,255,0.1); color: #E2E8F0; }
    .confirm-yes {
      padding: 10px 24px; border-radius: 10px;
      background: linear-gradient(135deg, #D97706, #F59E0B);
      border: none; color: #000; font-family: 'Space Grotesk', sans-serif;
      font-weight: 600; font-size: 13px; cursor: pointer; transition: all 0.2s;
    }
    .confirm-yes:hover { box-shadow: 0 4px 20px rgba(245,158,11,0.3); }

    /* Deep timer */
    .deep-timer {
      font-family: 'JetBrains Mono', monospace;
      font-size: 13px; font-weight: 600;
      color: #F59E0B; letter-spacing: 1px;
    }

    /* User info in header */
    .user-info {
      display: flex; align-items: center; gap: 10px;
    }
    .user-avatar {
      width: 28px; height: 28px; border-radius: 50%;
      border: 1px solid rgba(255,255,255,0.15);
    }
    .user-avatar-fallback {
      width: 28px; height: 28px; border-radius: 50%;
      background: linear-gradient(135deg, #3B82F6, #8B5CF6);
      display: flex; align-items: center; justify-content: center;
      font-size: 12px; font-weight: 700; color: #fff;
      font-family: 'Space Grotesk', sans-serif;
    }
    .user-name {
      font-size: 12px; color: #94A3B8;
      font-family: 'Space Grotesk', sans-serif; font-weight: 500;
    }
    .signout-btn {
      font-size: 11px; color: #64748B; text-decoration: none;
      padding: 4px 10px; border-radius: 6px;
      border: 1px solid rgba(255,255,255,0.08);
      transition: all 0.2s;
      font-family: 'Space Grotesk', sans-serif;
    }
    .signout-btn:hover { color: #E2E8F0; border-color: rgba(255,255,255,0.2); }

    /* Base styles for elements converted from inline styles */
    .header-right { display: flex; align-items: center; gap: 12px; }
    .query-hint-row { display: flex; align-items: center; gap: 10px; min-width: 0; }

    /* ===== Tablet & Large Phone (<=768px) ===== */
    @media (max-width: 768px) {
      /* Header: wrap to two rows when tight */
      .header { flex-wrap: wrap; gap: 12px; padding: 16px; }
      .header-title { font-size: 20px; }

      /* Container */
      .container { padding: 16px; }

      /* Roster: 1 column vertical stack */
      .roster { grid-template-columns: 1fr; gap: 8px; margin-bottom: 16px; }

      /* Input: 16px font prevents iOS auto-zoom, 80px min height */
      .query-input { font-size: 16px; min-height: 80px; }

      /* Footer: stack toggle + button vertically, hint below */
      .query-footer { flex-direction: column; align-items: stretch; }
      .query-hint-row { order: 2; justify-content: center; margin-top: 4px; }
      .query-controls { flex-direction: column; width: 100%; gap: 10px; }
      .mode-toggle { align-self: center; }
      .run-btn { width: 100%; }

      /* Mode toggle: 44px min touch target */
      .mode-opt { padding: 12px 16px; font-size: 12px; }

      /* Thinking labels: don't overflow cards */
      .thinking-label { font-size: 9px; min-width: 0; overflow: hidden; text-overflow: ellipsis; }

      /* Response cards */
      .response-card { padding: 14px; }
      .response-text { font-size: 14px; }
      .response-header { gap: 8px; }
      .synthesis-card { padding: 16px; }

      /* Panels */
      .history-panel { padding: 16px; }
      .confirm-box { padding: 24px 20px; }

      /* User info: hide name on small screens */
      .user-name { display: none; }
    }

    /* ===== Small Phone: iPhone SE 375px, iPhone 14 390px, Pixel 412px ===== */
    @media (max-width: 480px) {
      .header { padding: 12px; gap: 10px; }
      .header-title { font-size: 18px; }
      .header-sub { font-size: 10px; letter-spacing: 0.5px; }

      .container { padding: 12px; }

      /* Tighter roster cards */
      .roster-card { padding: 10px 12px; gap: 8px; }
      .agent-name { font-size: 12px; }
      .agent-role { font-size: 9px; }

      .query-input { padding: 12px 14px; }

      /* Response header: wrap provider tag to next line */
      .response-header { flex-wrap: wrap; }
      .provider-tag { margin-left: 0; }

      /* Suggestions */
      .suggestion-btn { font-size: 11px; padding: 6px 10px; }

      /* Confirm dialog: stack buttons */
      .confirm-title { font-size: 18px; }
      .confirm-text { font-size: 12px; }
      .confirm-btns { flex-direction: column; }
      .confirm-no, .confirm-yes { width: 100%; text-align: center; }

      /* Empty state */
      .empty-state { padding: 40px 12px; }
      .empty-title { font-size: 16px; }
      .empty-text { font-size: 12px; }

      /* Status elements */
      .deep-timer { font-size: 12px; }
      .query-hint { font-size: 10px; }
      .status-badge { font-size: 10px; padding: 3px 8px; }
    }

    /* === Agent Controls === */
    .roster-card { flex-wrap: wrap; position: relative; }
    .agent-controls { display: flex; align-items: center; gap: 6px; width: 100%; margin-top: 6px; padding-top: 6px; border-top: 1px solid rgba(255,255,255,0.04); }
    .agent-power { width: 32px; height: 18px; border-radius: 9px; background: rgba(255,255,255,0.1); cursor: pointer; position: relative; transition: background 0.2s; flex-shrink: 0; }
    .agent-power.on { background: rgba(16,185,129,0.4); }
    .agent-power::after { content: ''; position: absolute; top: 2px; left: 2px; width: 14px; height: 14px; border-radius: 50%; background: #475569; transition: all 0.2s; }
    .agent-power.on::after { left: 16px; background: #10B981; }
    .agent-mode-btns { display: flex; gap: 2px; background: rgba(255,255,255,0.05); border-radius: 6px; padding: 2px; }
    .agent-mode-btn { padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 600; cursor: pointer; border: none; background: transparent; color: #64748B; transition: all 0.2s; font-family: 'JetBrains Mono', monospace; }
    .agent-mode-btn.active { background: rgba(255,255,255,0.1); color: #E2E8F0; }
    .agent-mode-btn.deep.active { background: rgba(245,158,11,0.25); color: #F59E0B; }
    .agent-est { margin-left: auto; font-size: 11px; font-family: 'JetBrains Mono', monospace; color: #64748B; }
    .agent-est.has-cost { color: #F59E0B; }
    .roster-card.off { opacity: 0.35; }
    .roster-card.off .agent-mode-btns { pointer-events: none; }
    .cost-meter { background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.06); border-radius: 10px; padding: 12px 16px; margin-bottom: 16px; }
    .cost-header { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
    .cost-icon { font-size: 16px; }
    .cost-label { font-size: 12px; color: #64748B; font-weight: 500; letter-spacing: 0.5px; }
    .cost-total { margin-left: auto; font-size: 18px; font-weight: 700; font-family: 'JetBrains Mono', monospace; color: #F59E0B; }
    .cost-breakdown { display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 8px; }
    .cost-item { font-size: 11px; color: #94A3B8; font-family: 'JetBrains Mono', monospace; }
    .cost-item .name { color: #64748B; }
    .cost-item .val { color: #E2E8F0; font-weight: 600; }
    .cost-item.off .val { color: #475569; }
    .cost-footer { display: flex; gap: 24px; font-size: 11px; color: #475569; border-top: 1px solid rgba(255,255,255,0.04); padding-top: 8px; }
    .cost-footer strong { color: #94A3B8; }
    .register { background: rgba(16,185,129,0.05); border: 1px solid rgba(16,185,129,0.2); border-radius: 10px; padding: 12px 16px; margin-bottom: 16px; animation: registerIn 0.5s ease; }
    .register-header { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
    .register-label { font-size: 12px; color: #10B981; font-weight: 600; letter-spacing: 0.5px; }
    .register-total { margin-left: auto; font-size: 18px; font-weight: 700; font-family: 'JetBrains Mono', monospace; color: #10B981; }
    .register-breakdown { display: flex; gap: 12px; flex-wrap: wrap; }
    .register-item { font-size: 11px; font-family: 'JetBrains Mono', monospace; }
    .register-item .name { color: #64748B; }
    .register-item .val { color: #10B981; font-weight: 600; }
    @keyframes registerIn { from { opacity: 0; transform: translateY(-8px); } to { opacity: 1; transform: translateY(0); } }
    .consolidator-label { font-size: 10px; color: #64748B; letter-spacing: 0.5px; margin-right: 4px; }
  </style>
</head>
<body>
  <!-- Deep Research Confirmation Dialog -->
  <div id="deepConfirm" class="confirm-overlay" style="display:none;">
    <div class="confirm-box">
      <div class="confirm-icon">&#x1F52C;</div>
      <div class="confirm-title">Deep Research Mode</div>
      <div class="confirm-text">
        This consultation will take 2-15 minutes depending on agent modes.
        <div id="confirmCostPreview" style="margin-top:10px;font-family:'JetBrains Mono',monospace;font-size:13px;color:#F59E0B;"></div>
      </div>
      <div class="confirm-btns">
        <button class="confirm-no" onclick="cancelDeep()">Cancel</button>
        <button class="confirm-yes" onclick="confirmDeep()">Start Deep Research</button>
      </div>
    </div>
  </div>

  <div class="header">
    <div class="header-left">
      <div class="logo">A</div>
      <div>
        <div class="header-title">A-TEAM CONSOLE</div>
        <div class="header-sub">v5.6 &middot; 4 AI BRAINS &middot; 4 REAL APIs</div>
      </div>
    </div>
    <div class="header-right">
      <div id="statusBadge" class="status-badge">
        <div class="status-dot"></div>
        <span id="statusText">CHECKING...</span>
      </div>
      <button id="historyBtn" class="history-btn" style="display:none;" onclick="toggleHistory()">
        History (<span id="historyCount">0</span>)
      </button>
      <div id="userInfo" class="user-info" style="display:none;">
        <span id="userName" class="user-name"></span>
        <a href="/auth/logout" class="signout-btn">Sign Out</a>
      </div>
    </div>
  </div>

  <div class="container">
    <!-- Agent Roster -->
    <div class="roster">
      <div class="roster-card" id="card-claude" style="--agent-color:#F59E0B66;">
        <div class="agent-avatar" style="background:#D97706;">C</div>
        <div style="min-width:0;flex:1;"><div class="agent-name">Claude</div><div class="agent-role">Principal Architect</div></div>
        <div class="thinking-label" style="color:#D97706;display:none;" id="think-claude">THINKING...</div>
        <div class="done-dot" style="display:none;" id="done-claude"></div>
        <div class="agent-controls">
          <div class="agent-power on" id="power-claude" onclick="toggleAgentPower('claude')"></div>
          <div class="agent-mode-btns"><button class="agent-mode-btn active" id="btn-claude-quick" onclick="setAgentMode('claude','quick')">Quick</button><button class="agent-mode-btn deep" id="btn-claude-deep" onclick="setAgentMode('claude','deep')">Deep</button></div>
          <div class="agent-est" id="est-claude">~$0.007</div>
        </div>
      </div>
      <div class="roster-card" id="card-chatgpt" style="--agent-color:#10B98166;">
        <div class="agent-avatar" style="background:#059669;">G</div>
        <div style="min-width:0;flex:1;"><div class="agent-name">ChatGPT</div><div class="agent-role">Financial Analyst</div></div>
        <div class="thinking-label" style="color:#059669;display:none;" id="think-chatgpt">THINKING...</div>
        <div class="done-dot" style="display:none;" id="done-chatgpt"></div>
        <div class="agent-controls">
          <div class="agent-power on" id="power-chatgpt" onclick="toggleAgentPower('chatgpt')"></div>
          <div class="agent-mode-btns"><button class="agent-mode-btn active" id="btn-chatgpt-quick" onclick="setAgentMode('chatgpt','quick')">Quick</button><button class="agent-mode-btn deep" id="btn-chatgpt-deep" onclick="setAgentMode('chatgpt','deep')">Deep</button></div>
          <div class="agent-est" id="est-chatgpt">~$0.000</div>
        </div>
      </div>
      <div class="roster-card" id="card-gemini" style="--agent-color:#3B82F666;">
        <div class="agent-avatar" style="background:#2563EB;">G</div>
        <div style="min-width:0;flex:1;"><div class="agent-name">Gemini</div><div class="agent-role">Data Analyst</div></div>
        <div class="thinking-label" style="color:#2563EB;display:none;" id="think-gemini">THINKING...</div>
        <div class="done-dot" style="display:none;" id="done-gemini"></div>
        <div class="agent-controls">
          <div class="agent-power on" id="power-gemini" onclick="toggleAgentPower('gemini')"></div>
          <div class="agent-mode-btns"><button class="agent-mode-btn active" id="btn-gemini-quick" onclick="setAgentMode('gemini','quick')">Quick</button><button class="agent-mode-btn deep" id="btn-gemini-deep" onclick="setAgentMode('gemini','deep')">Deep</button></div>
          <div class="agent-est" id="est-gemini">~$0.000</div>
        </div>
      </div>
      <div class="roster-card" id="card-grok" style="--agent-color:#EF444466;">
        <div class="agent-avatar" style="background:#DC2626;">X</div>
        <div style="min-width:0;flex:1;"><div class="agent-name">Grok</div><div class="agent-role">Devil's Advocate</div></div>
        <div class="thinking-label" style="color:#DC2626;display:none;" id="think-grok">THINKING...</div>
        <div class="done-dot" style="display:none;" id="done-grok"></div>
        <div class="agent-controls">
          <div class="agent-power on" id="power-grok" onclick="toggleAgentPower('grok')"></div>
          <div class="agent-mode-btns"><button class="agent-mode-btn active" id="btn-grok-quick" onclick="setAgentMode('grok','quick')">Quick</button><button class="agent-mode-btn deep" id="btn-grok-deep" onclick="setAgentMode('grok','deep')">Deep</button></div>
          <div class="agent-est" id="est-grok">~$0.001</div>
        </div>
      </div>
    </div>

    <!-- Cost Meter -->
    <div class="cost-meter" id="costMeter">
      <div class="cost-header">
        <span class="cost-icon">&#x1F4B0;</span>
        <span class="cost-label">ESTIMATED COST</span>
        <span class="cost-total" id="costTotal">$0.00</span>
      </div>
      <div class="cost-breakdown" id="costBreakdown"></div>
      <div class="cost-footer">
        <span>Today: <strong id="costToday">$0.00</strong></span>
        <span>All-time: <strong id="costAllTime">$0.00</strong></span>
      </div>
    </div>

    <!-- Register (shown after completion) -->
    <div id="registerPanel" style="display:none;"></div>
    <!-- Query Input -->
    <div class="query-area">
      <textarea id="queryInput" class="query-input" rows="3"
        placeholder="Ask your A-Team a question... (Enter to send)"></textarea>
      <div class="query-footer">
        <div class="query-hint-row">
          <div class="query-hint" id="statusHint">4 real AI providers — each agent is a different brain</div>
          <span class="deep-timer" id="deepTimer" style="display:none;">0:00</span>
        </div>
        <div class="query-controls">
          <span class="consolidator-label">CONSOLIDATOR:</span>
          <div class="mode-toggle" id="modeToggle" onclick="toggleMode()">
            <div class="mode-slider" id="modeSlider"></div>
            <span class="mode-opt active" id="optQuick">Quick</span>
            <span class="mode-opt" id="optDeep">Deep Research</span>
          </div>
          <button id="runBtn" class="run-btn" onclick="runConsultation()">CONSULT A-TEAM</button>
        </div>
      </div>
    </div>

    <!-- Error -->
    <div id="errorBox" class="error-box" style="display:none;"></div>

    <!-- Responses -->
    <div id="responses" class="responses"></div>

    <!-- History -->
    <div id="historyPanel" class="history-panel" style="display:none;">
      <div class="history-title">Consultation History</div>
      <div id="historyList"></div>
    </div>

    <!-- Empty State -->
    <div id="emptyState" class="empty-state">
      <div class="empty-star">&#9733;</div>
      <div class="empty-title">Your A-Team is ready</div>
      <div class="empty-text">
        Ask any question and get perspectives from four different AI brains.
        Claude (Anthropic), ChatGPT (OpenAI), Gemini (Google), and Grok (xAI).
      </div>
      <div class="suggestions">
        <button class="suggestion-btn" onclick="setQuery('Should we start with SPY or SOXL for our first paper trading tests, and why?')">SPY vs SOXL for paper trading?</button>
        <button class="suggestion-btn" onclick="setQuery('What are the biggest risks with SOXL day trading for a $30K account?')">SOXL day trading risks?</button>
        <button class="suggestion-btn" onclick="setQuery('Compare Alpaca vs TradeStation vs TradersPost for automated trading')">Alpaca vs TradeStation?</button>
      </div>
    </div>
  </div>

  <script>
    const AGENTS = [
      { id: 'claude', name: 'Claude', role: 'Principal Architect & Team Lead', color: '#D97706', provider: 'Anthropic' },
      { id: 'chatgpt', name: 'ChatGPT', role: 'Financial Research Analyst', color: '#059669', provider: 'OpenAI' },
      { id: 'gemini', name: 'Gemini', role: 'Data Analyst & Ranker', color: '#2563EB', provider: 'Google' },
      { id: 'grok', name: 'Grok', role: "Devil's Advocate & Risk Analyst", color: '#DC2626', provider: 'xAI' }
    ];
    let isRunning = false;
    let history = [];
    let currentMode = 'quick';
    let pendingDeepQuery = null;

    const agentConfig = {
      claude:  { on: true, mode: 'quick' },
      chatgpt: { on: true, mode: 'quick' },
      gemini:  { on: true, mode: 'quick' },
      grok:    { on: true, mode: 'quick' }
    };

    function toggleAgentPower(id) {
      if (isRunning) return;
      agentConfig[id].on = !agentConfig[id].on;
      const el = document.getElementById('power-' + id);
      const card = document.getElementById('card-' + id);
      if (agentConfig[id].on) { el.classList.add('on'); card.classList.remove('off'); }
      else { el.classList.remove('on'); card.classList.add('off'); }
      updateEstimate();
    }

    function setAgentMode(id, mode) {
      if (isRunning) return;
      agentConfig[id].mode = mode;
      document.getElementById('btn-' + id + '-quick').classList.toggle('active', mode === 'quick');
      document.getElementById('btn-' + id + '-deep').classList.toggle('active', mode === 'deep');
      updateEstimate();
    }

    function getActiveAgents() { return Object.entries(agentConfig).filter(([_, c]) => c.on).map(([id]) => id); }
    function getAgentModes() {
      const modes = {};
      for (const [id, c] of Object.entries(agentConfig)) modes[id] = c.on ? c.mode : 'off';
      return modes;
    }

    async function updateEstimate() {
      const query = document.getElementById('queryInput').value || 'sample query';
      try {
        const res = await fetch('/api/estimate', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ query, agentModes: getAgentModes(), consolidatorMode: currentMode })
        });
        const data = await res.json();
        for (const [id, est] of Object.entries(data.estimates)) {
          const el = document.getElementById('est-' + id);
          if (el) {
            if (est.mode === 'off') { el.textContent = ''; el.classList.remove('has-cost'); }
            else { el.textContent = '~$' + est.cost.toFixed(est.cost < 0.01 ? 4 : 2); el.classList.add('has-cost'); }
          }
        }
        const breakdown = document.getElementById('costBreakdown');
        let items = '';
        for (const agent of AGENTS) {
          const est = data.estimates[agent.id];
          if (est) {
            const cls = est.mode === 'off' ? 'cost-item off' : 'cost-item';
            const val = est.mode === 'off' ? 'OFF' : '$' + est.cost.toFixed(est.cost < 0.01 ? 4 : 2);
            items += '<span class="' + cls + '"><span class="name">' + agent.name + ':</span> <span class="val">' + val + '</span></span> ';
          }
        }
        if (data.consolidator) items += '<span class="cost-item"><span class="name">Consolidator:</span> <span class="val">$' + data.consolidator.cost.toFixed(2) + '</span></span>';
        breakdown.innerHTML = items;
        document.getElementById('costTotal').textContent = '$' + data.total.toFixed(2);
      } catch (e) {}
    }

    async function loadUsageStats() {
      try {
        const res = await fetch('/api/usage');
        const data = await res.json();
        if (data.today) document.getElementById('costToday').textContent = '$' + (data.today.today_cost || '0.00');
        if (data.total) document.getElementById('costAllTime').textContent = '$' + (data.total.total_cost || '0.00');
      } catch (e) {}
    }

    function showRegister(costs, synthesisCost) {
      const panel = document.getElementById('registerPanel');
      let total = 0, items = '';
      for (const agent of AGENTS) {
        const c = costs[agent.id];
        if (c) { total += c.cost; items += '<span class="register-item"><span class="name">' + agent.name + ':</span> <span class="val">$' + c.cost.toFixed(4) + '</span></span> '; }
      }
      if (synthesisCost) { total += synthesisCost.cost; items += '<span class="register-item"><span class="name">Consolidator:</span> <span class="val">$' + synthesisCost.cost.toFixed(4) + '</span></span>'; }
      panel.innerHTML = '<div class="register"><div class="register-header"><span class="register-icon">&#x1F9FE;</span><span class="register-label">ACTUAL COST</span><span class="register-total">$' + total.toFixed(4) + '</span></div><div class="register-breakdown">' + items + '</div></div>';
      panel.style.display = 'block';
      loadUsageStats();
    }

    // --- Load user info ---
    async function loadUser() {
      try {
        const res = await fetch('/api/me');
        if (!res.ok) return;
        const user = await res.json();
        const infoEl = document.getElementById('userInfo');
        const nameEl = document.getElementById('userName');

        // Insert avatar before the name
        if (user.avatar) {
          const img = document.createElement('img');
          img.src = user.avatar;
          img.className = 'user-avatar';
          img.referrerPolicy = 'no-referrer';
          infoEl.insertBefore(img, nameEl);
        } else {
          const fb = document.createElement('div');
          fb.className = 'user-avatar-fallback';
          fb.textContent = (user.name || 'U')[0].toUpperCase();
          infoEl.insertBefore(fb, nameEl);
        }

        nameEl.textContent = user.name || user.email || '';
        infoEl.style.display = 'flex';
      } catch {}
    }

    // --- Auth-aware fetch wrapper ---
    async function authFetch(url, opts) {
      const res = await fetch(url, opts);
      if (res.status === 401) {
        window.location.href = '/login';
        throw new Error('Session expired');
      }
      return res;
    }

    // --- Init ---
    document.addEventListener('DOMContentLoaded', () => {
      loadUser();
      checkHealth();
      requestAnimationFrame(updateToggleUI);
      updateEstimate();
      loadUsageStats();
      document.getElementById('queryInput').addEventListener('input', debounce(updateEstimate, 500));
    });
    function debounce(fn, ms) { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), ms); }; }
    // --- Mode Toggle ---
    function toggleMode() {
      if (isRunning) return;
      currentMode = currentMode === 'quick' ? 'deep' : 'quick';
      updateToggleUI();
      updateEstimate();
    }

    function updateToggleUI() {
      const toggle = document.getElementById('modeToggle');
      const slider = document.getElementById('modeSlider');
      const optQuick = document.getElementById('optQuick');
      const optDeep = document.getElementById('optDeep');
      const activeOpt = currentMode === 'deep' ? optDeep : optQuick;

      slider.style.left = activeOpt.offsetLeft + 'px';
      slider.style.width = activeOpt.offsetWidth + 'px';

      if (currentMode === 'deep') {
        toggle.classList.add('deep');
        optQuick.classList.remove('active');
        optDeep.classList.add('active');
      } else {
        toggle.classList.remove('deep');
        optQuick.classList.add('active');
        optDeep.classList.remove('active');
      }
    }

    // --- Deep mode confirmation ---
    function cancelDeep() {
      document.getElementById('deepConfirm').style.display = 'none';
      pendingDeepQuery = null;
    }

    async function confirmDeep() {
      document.getElementById('deepConfirm').style.display = 'none';
      const query = pendingDeepQuery;
      pendingDeepQuery = null;
      if (query) await runTeamConsultation(query);
    }

    // Check API health on load
    async function checkHealth() {
      try {
        const res = await authFetch('/api/health');
        const data = await res.json();
        const count = Object.values(data.providers).filter(Boolean).length;
        const badge = document.getElementById('statusText');
        const dot = document.querySelector('.status-dot');
        if (count === 4) {
          badge.textContent = '4/4 APIS LIVE';
          dot.style.background = '#10B981';
        } else if (count > 0) {
          badge.textContent = `${count}/4 APIS`;
          dot.style.background = '#F59E0B';
        } else {
          badge.textContent = 'NO APIS';
          dot.style.background = '#EF4444';
        }
      } catch {
        document.getElementById('statusText').textContent = 'OFFLINE';
        document.querySelector('.status-dot').style.background = '#EF4444';
      }
    }

    // Input handling
    const input = document.getElementById('queryInput');
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        runConsultation();
      }
    });

    function setQuery(q) { input.value = q; input.focus(); }

    function toggleHistory() {
      const panel = document.getElementById('historyPanel');
      panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
    }

    function showAgent(agentId, state) {
      const card = document.getElementById(`card-${agentId}`);
      const think = document.getElementById(`think-${agentId}`);
      const done = document.getElementById(`done-${agentId}`);

      if (state === 'thinking') {
        card.classList.add('active');
        think.style.display = 'block';
        think.textContent = 'THINKING...';
        done.style.display = 'none';
      } else if (state === 'researching') {
        card.classList.add('active');
        think.style.display = 'block';
        think.textContent = '\u{1F52C} RESEARCHING...';
        done.style.display = 'none';
      } else if (state === 'done') {
        card.classList.remove('active');
        think.style.display = 'none';
        done.style.display = 'block';
      } else {
        card.classList.remove('active');
        think.style.display = 'none';
        done.style.display = 'none';
      }
    }

    function addResponseCard(agent, text, modeTag) {
      const bgAlpha = agent.id === 'claude' ? '217,119,6' :
                       agent.id === 'chatgpt' ? '5,150,105' :
                       agent.id === 'gemini' ? '37,99,235' : '220,38,38';

      const tagHtml = modeTag
        ? `<span class="provider-tag" style="${modeTag === 'deep' ? 'color:#F59E0B;background:rgba(217,119,6,0.15);' : ''}">${modeTag === 'deep' ? '\u{1F52C} DEEP' : modeTag === 'fallback' ? '\u26A0\uFE0F FALLBACK' : agent.provider + ' API'}</span>`
        : `<span class="provider-tag">${agent.provider} API</span>`;

      const card = document.createElement('div');
      card.className = 'response-card';
      card.style.background = `rgba(${bgAlpha},0.06)`;
      card.style.border = `1px solid ${agent.color}33`;
      card.innerHTML = `
        <div class="top-bar" style="background:${agent.color}"></div>
        <div class="response-header">
          <div class="response-avatar" style="background:${agent.color}">${agent.id === 'grok' ? 'X' : agent.name[0]}</div>
          <div>
            <span class="response-name">${agent.name}</span>
            <span class="response-role">${agent.role}</span>
          </div>
          ${tagHtml}
        </div>
        <div class="response-text">${escapeHtml(text)}</div>
      `;
      document.getElementById('responses').appendChild(card);
    }

    function addSynthesisCard(text) {
      const card = document.createElement('div');
      card.className = 'synthesis-card';
      card.innerHTML = `
        <div class="top-bar"></div>
        <div class="response-header">
          <div class="response-avatar" style="background:linear-gradient(135deg,#F59E0B,#EF4444)">A</div>
          <div>
            <span class="response-name">Principal Architect Synthesis</span>
            <span class="response-role">Team Lead Summary</span>
          </div>
        </div>
        <div class="response-text">${escapeHtml(text)}</div>
      `;
      document.getElementById('responses').appendChild(card);
    }

    function escapeHtml(str) {
      return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }

    // --- Main consultation dispatcher ---
    async function runConsultation() {
      const query = input.value.trim();
      if (!query || isRunning) return;
      const activeAgents = getActiveAgents();
      if (activeAgents.length === 0) {
        document.getElementById('errorBox').textContent = 'No agents active. Turn on at least one consultant.';
        document.getElementById('errorBox').style.display = 'block';
        return;
      }
      const hasDeep = activeAgents.some(id => agentConfig[id].mode === 'deep') || currentMode === 'deep';
      if (hasDeep) {
        pendingDeepQuery = query;
        document.getElementById('confirmCostPreview').textContent = 'Estimated cost: ' + document.getElementById('costTotal').textContent;
        document.getElementById('deepConfirm').style.display = 'flex';
        return;
      }
      await runTeamConsultation(query);
    }
    // --- Quick mode (existing synchronous flow) ---
    // Unified team consultation — handles all modes via background job
    async function runTeamConsultation(query) {
      isRunning = true;
      const activeAgents = getActiveAgents();
      const modes = getAgentModes();
      const hasDeep = activeAgents.some(id => agentConfig[id].mode === 'deep') || currentMode === 'deep';
      
      document.getElementById('runBtn').disabled = true;
      document.getElementById('runBtn').textContent = hasDeep ? '\u{1F52C} RESEARCHING...' : 'CONSULTING...';
      document.getElementById('responses').innerHTML = '';
      document.getElementById('registerPanel').style.display = 'none';
      document.getElementById('emptyState').style.display = 'none';
      document.getElementById('errorBox').style.display = 'none';

      AGENTS.forEach(a => {
        if (agentConfig[a.id].on) showAgent(a.id, agentConfig[a.id].mode === 'deep' ? 'researching' : 'thinking');
        else showAgent(a.id, 'idle');
      });

      const startTime = Date.now();
      const timerEl = document.getElementById('deepTimer');
      timerEl.style.display = 'inline';
      timerEl.textContent = '0:00';
      const timerInterval = setInterval(() => {
        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        timerEl.textContent = Math.floor(elapsed / 60) + ':' + String(elapsed % 60).padStart(2, '0');
      }, 1000);

      const activeCount = activeAgents.length;
      document.getElementById('statusHint').textContent = hasDeep
        ? '\u{1F52C} Research in progress \u2014 ' + activeCount + ' agents working...'
        : 'Consulting ' + activeCount + ' agents...';

      try {
        const res = await authFetch('/api/consult', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ query, mode: 'team', activeAgents, agentModes: modes, consolidatorMode: currentMode })
        });
        const data = await res.json();
        if (data.error) throw new Error(data.error);
        const jobId = data.jobId;

        while (true) {
          await new Promise(r => setTimeout(r, 3000));
          const pollRes = await authFetch('/api/results/' + jobId);
          const poll = await pollRes.json();
          if (poll.error) throw new Error(poll.error);

          if (poll.status === 'researching' || poll.status === 'synthesizing') {
            let doneCount = 0;
            for (const id of activeAgents) {
              const p = poll.progress?.[id];
              if (p && (p.status === 'done' || p.status === 'failed')) { showAgent(id, 'done'); doneCount++; }
            }
            document.getElementById('statusHint').textContent = poll.status === 'synthesizing'
              ? '\u{1F4CA} All agents done \u2014 Consolidator synthesizing...'
              : '\u{1F52C} ' + doneCount + '/' + activeCount + ' agents completed...';
            continue;
          }

          if (poll.status === 'completed') {
            for (const agent of AGENTS) {
              if (!agentConfig[agent.id].on) continue;
              showAgent(agent.id, 'done');
              const r = poll.results[agent.id];
              if (r && r.response) addResponseCard(agent, r.response, r.mode);
              else addResponseCard(agent, '\u274C Failed: ' + (r ? r.error : 'No response'));
            }
            if (poll.synthesis) addSynthesisCard(poll.synthesis);
            if (poll.costs || poll.synthesisCost) showRegister(poll.costs || {}, poll.synthesisCost);

            const allResponses = {};
            for (const id of activeAgents) {
              const r = poll.results[id];
              if (r && r.response) allResponses[id] = r.response;
            }
            history.unshift({ query, responses: allResponses, synthesis: poll.synthesis, timestamp: new Date().toLocaleTimeString() });
            updateHistoryUI();
            break;
          }
          if (poll.status === 'failed') throw new Error('Research job failed');
        }
      } catch (err) {
        if (err.message === 'Session expired') return;
        document.getElementById('errorBox').textContent = 'Error: ' + err.message;
        document.getElementById('errorBox').style.display = 'block';
      }

      clearInterval(timerInterval);
      timerEl.style.display = 'none';
      isRunning = false;
      document.getElementById('runBtn').disabled = false;
      document.getElementById('runBtn').textContent = 'CONSULT A-TEAM';
      document.getElementById('statusHint').textContent = activeCount + ' AI providers ready';
      AGENTS.forEach(a => showAgent(a.id, 'idle'));
    }


    function updateHistoryUI() {
      const btn = document.getElementById('historyBtn');
      const count = document.getElementById('historyCount');
      const list = document.getElementById('historyList');

      if (history.length > 0) {
        btn.style.display = 'inline-block';
        count.textContent = history.length;
        list.innerHTML = history.map((h, i) => `
          <div class="history-item" onclick="reloadHistory(${i})">
            <div class="history-query">"${escapeHtml(h.query)}"</div>
            <div class="history-meta">${h.timestamp} \u00B7 4 responses + synthesis</div>
          </div>
        `).join('');
      }
    }

    function reloadHistory(index) {
      const h = history[index];
      document.getElementById('responses').innerHTML = '';
      document.getElementById('emptyState').style.display = 'none';
      input.value = h.query;

      AGENTS.forEach(agent => {
        if (h.responses[agent.id]) {
          addResponseCard(agent, h.responses[agent.id]);
          showAgent(agent.id, 'done');
        }
      });
      if (h.synthesis) addSynthesisCard(h.synthesis);
      document.getElementById('historyPanel').style.display = 'none';
    }
  </script>
</body>
</html>
